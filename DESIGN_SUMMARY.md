# 設計書サマリー

このドキュメントは、TelBot Order Djangoプロジェクトの全体設計概要を提供します。

## ドキュメント構成

### 1. [システム開発要件（youken.md）](youken.md)
- システム全体の概要
- 顧客向け機能要件
- 店舗運用機能要件
- Telegram Bot情報
- 開発環境

### 2. [データモデル設計書（data_model.md）](data_model.md)
- エンティティ定義（11モデル）
- ER図とリレーション
- 主要業務フロー
- 画像管理仕様
- データ整合性ルール

### 3. [機能詳細設計書（functional_design.md）](functional_design.md)
- システムアーキテクチャ
- 顧客向け機能詳細（8機能）
- 店舗運用機能詳細（5機能）
- API仕様（エンドポイント、リクエスト/レスポンス形式）
- セキュリティ要件
- パフォーマンス要件
- エラーハンドリング

### 4. [画面詳細設計書（screen_design.md）](screen_design.md)
- 顧客向け画面仕様（13画面）
- 店舗運用画面仕様（7画面）
- 画面遷移図
- レスポンシブデザイン
- デザインシステム（カラー、タイポグラフィ、スペーシング）
- アクセシビリティ要件

---

## システム概要

### 目的
飲食店における顧客のスマートフォンからの注文と、店舗側の注文管理を効率化するシステム

### 主要機能

#### 顧客向け（Telegram Mini Apps）
1. **QRコードスキャン・セッション開始**
   - テーブルQRスキャンで来店セッション作成
   - 来店人数入力
   - セッション復帰機能

2. **メニュー閲覧**
   - カテゴリ別表示
   - 商品画像（サムネイル・詳細）
   - 売り切れ表示

3. **注文機能**
   - カート機能
   - 数量選択
   - 備考入力（アレルギー対応等）
   - グループ注文（複数人同時注文）
   - 追加注文

4. **注文履歴確認**
   - セッション内全注文表示
   - ステータス確認（未調理、調理中、完了、提供済み）

5. **会計機能**
   - テーブル単位一括会計
   - QRコードレシート表示
   - 会計キャンセル（追加注文用）

6. **店員呼び出し**
   - 理由選択式（お水、会計、質問、苦情、その他）
   - 追加メッセージ入力

#### 店舗運用（Webブラウザ）
1. **調理ダッシュボード**
   - リアルタイム注文表示
   - ステータス管理（未調理→調理中→完了→提供済み）
   - 経過時間警告
   - 音声通知

2. **メニュー管理**
   - 商品登録・編集・削除
   - 画像アップロード（自動リサイズ）
   - カテゴリ管理
   - 表示順序設定

3. **売り切れ管理**
   - 手動での提供可能/不可切り替え
   - 一括設定機能

4. **会計管理**
   - 会計依頼一覧
   - 支払い方法選択（現金、クレジット、電子マネー）
   - レシート印刷
   - セッション完了処理

5. **売上レポート**
   - 日次・月次集計
   - 売上推移グラフ
   - 人気商品ランキング
   - CSVエクスポート

---

## 技術アーキテクチャ

### バックエンド
- **フレームワーク**: Django 5.0
- **API**: Django REST Framework 3.14
- **データベース**: SQLite（開発）、PostgreSQL（本番推奨）
- **認証**: Django標準認証、Telegram認証

### フロントエンド
- **顧客側**: Telegram Mini Apps（HTML/CSS/JavaScript）
- **店舗側**: Django Admin + カスタムダッシュボード

### 外部連携
- **Telegram Bot API**: python-telegram-bot 21.0
- **画像処理**: Pillow 10.4

### セキュリティ
- HTTPS通信（本番環境必須）
- CSRF保護
- パスワードハッシュ化
- 入力バリデーション
- SQL Injection対策（ORM使用）

---

## データモデル概要

### 主要エンティティ（11モデル）

```
Store（店舗）
  ├─ Table（テーブル）
  ├─ Category（カテゴリ）
  ├─ MenuItem（メニュー項目）
  │   └─ MenuItemImage（メニュー画像）
  └─ User（ユーザー/スタッフ）

Session（来店セッション）
  ├─ Order（注文）
  │   └─ OrderItem（注文明細）
  ├─ StaffCall（店員呼び出し）
  └─ Payment（会計）- 1対1
```

### リレーション
- Store 1 : N Table, Category, MenuItem, User
- Table 1 : N Session
- Session 1 : N Order, StaffCall
- Session 1 : 1 Payment
- Order 1 : N OrderItem

---

## API設計概要

### 主要エンドポイント

#### セッション管理
- `POST /api/sessions/start/` - セッション開始確認
- `POST /api/sessions/create/` - セッション作成
- `GET /api/sessions/validate/` - セッション検証

#### メニュー
- `GET /api/menu/categories/` - カテゴリ一覧
- `GET /api/menu/items/` - メニュー一覧
- `GET /api/menu/items/{id}/` - メニュー詳細
- `PATCH /api/menu/items/{id}/availability/` - 売り切れ切替

#### 注文
- `POST /api/orders/create/` - 注文作成
- `GET /api/orders/history/` - 注文履歴
- `PATCH /api/orders/{id}/status/` - 注文ステータス更新
- `PATCH /api/order-items/{id}/status/` - 明細ステータス更新

#### 会計
- `POST /api/payments/request/` - 会計依頼
- `POST /api/payments/cancel/` - 会計キャンセル
- `GET /api/payments/pending/` - 会計待ち一覧
- `POST /api/payments/{id}/complete/` - 会計完了

#### ダッシュボード
- `GET /api/dashboard/orders/` - 調理ダッシュボード用注文一覧

#### 店員呼び出し
- `POST /api/staff-calls/create/` - 呼び出し作成

#### レポート
- `GET /api/reports/sales/` - 売上レポート

---

## 画面設計概要

### 顧客向け画面（13画面）

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| CS-001 | QRスキャン画面 | 初回起動時のQRコード読み取り |
| CS-002 | 来店人数入力画面 | セッション作成時の人数入力 |
| CS-003 | セッション復帰確認画面 | 既存セッション復帰の確認 |
| CS-004 | メニュー一覧画面 | カテゴリ別メニュー表示 |
| CS-005 | 商品詳細モーダル | 商品詳細と数量選択 |
| CS-006 | カート画面 | 注文前の確認・編集 |
| CS-007 | 注文確認モーダル | 注文内容の最終確認 |
| CS-008 | 注文完了画面 | 注文完了メッセージ |
| CS-009 | 注文履歴画面 | セッション内注文一覧 |
| CS-010 | 会計依頼画面 | 会計前の合計確認 |
| CS-011 | 会計依頼完了画面 | QRコードレシート表示 |
| CS-012 | 店員呼び出しモーダル | 理由選択と呼び出し |
| CS-013 | 呼び出し完了画面 | 呼び出し完了メッセージ |

### 店舗運用画面（7画面）

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| SS-001 | 調理ダッシュボード | リアルタイム注文管理 |
| SS-002 | 注文詳細モーダル | 個別注文の詳細表示 |
| SS-003 | 会計依頼一覧 | 会計待ちテーブル一覧 |
| SS-004 | 会計処理モーダル | 支払い方法選択と決済 |
| SS-005 | メニュー一覧 | Django Admin拡張 |
| SS-006 | メニュー編集画面 | 商品情報・画像編集 |
| SS-007 | 売上レポート | 売上分析とエクスポート |

---

## 開発優先順位

### Priority 1: MVP（Minimum Viable Product）
1. セッション管理（開始、復帰）
2. メニュー閲覧
3. 注文機能
4. 調理ダッシュボード
5. 会計処理

**目標**: 基本的な注文フローの実現

### Priority 2: 拡張機能
1. 注文履歴確認
2. 店員呼び出し
3. セッション復帰
4. 画像アップロード

**目標**: ユーザビリティ向上

### Priority 3: 運用支援
1. 売上管理
2. Telegram通知
3. リアルタイム更新（WebSocket）

**目標**: 運用効率化

---

## パフォーマンス要件

### レスポンスタイム
- API応答: 300ms以内（95パーセンタイル）
- 画像読み込み: 1秒以内
- ダッシュボード更新: 1秒以内

### 同時アクセス
- 想定同時接続: 100セッション
- ピーク時対応: 200セッション

### 最適化施策
- 画像lazy loading
- APIキャッシング（5分）
- データベースインデックス
- N+1クエリ防止

---

## セキュリティ要件

### 認証・認可
- Telegram Mini Apps: Telegram認証（init data検証）
- 管理画面: Django認証
- API: Token認証

### データ保護
- パスワードハッシュ化
- HTTPS通信（本番）
- CSRF保護
- SQL Injection対策

### 入力検証
- すべての入力をバリデーション
- 数量・価格は正の数のみ
- XSS対策

---

## 今後の拡張計画

### Phase 2
- 個別会計機能
- クーポン・割引機能
- 多言語対応（英語、中国語）

### Phase 3
- 在庫管理自動化
- 予約システム連携
- 顧客分析ダッシュボード
- マルチ店舗対応

---

## 開発ガイドライン

### コーディング規約
- PEP 8準拠（Python）
- DRY原則
- 意味のある変数名・関数名
- コメントは「なぜ」を説明

### テスト戦略
- ユニットテスト: 各モデル・API
- 統合テスト: 主要業務フロー
- E2Eテスト: ユーザーシナリオ

### Git運用
- コンベンショナルコミット（feat:, fix:, docs:等）
- main/masterへの直接コミット禁止
- プルリクエストベース

---

## 用語集

| 用語 | 説明 |
|------|------|
| セッション | 顧客の来店から退店までの1単位 |
| 注文 | 1回の注文操作単位（複数商品を含む） |
| 注文明細 | 注文内の個別商品 |
| グループ注文 | 同一テーブルで複数人が各自のスマホから注文 |
| 追加注文 | 初回注文後の追加オーダー |
| テーブル単位会計 | テーブルの全注文を一括で会計 |
| セッションコード | セッションを一意に識別するコード |
| スナップショット | 注文時の商品情報を保存する仕組み |

---

## 参考資料

- Django公式ドキュメント: https://docs.djangoproject.com/
- Django REST Framework: https://www.django-rest-framework.org/
- Telegram Bot API: https://core.telegram.org/bots/api
- Telegram Mini Apps: https://core.telegram.org/bots/webapps

---

**最終更新**: 2024-11-28  
**バージョン**: 1.0
